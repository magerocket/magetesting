<?php 
$this->headScript()->appendScript('
 //define globals
    var requests = [];
    var domain;
  
    //refresh statuses
    setInterval(updateStatuses,5000);

function updateStatuses(){
 
  $("tr.installing").each(function(){
  
      var current_tr = $(this);
              
      //create 
      domain = $(this).find(".instancedomain").val();
      requests[domain];

      //abort last request if it is still in queue
      if(typeof requests[domain] !== "undefined"){
	  requests[domain].abort();
      }
      
      //make new request
      requests[domain] = $.ajax({
            type: "POST",
            url: "'. $this->baseUrl("queue/getStatus") .'",
            data: "domain="+ $(this).find(".instancedomain").val(),
            dataType: "json",
            success: function(json){
                updateLabel(current_tr,json);
            }
      });
  });
}

function updateLabel(row,new_status){
    var labels = {
        "pending": "Pending", /* shouldn\'t update to this status anyway */
        "installing": "Installing",
        "ready": "Ready",
        "closed" : "Closed",
        "error": "Error",
        "installing-extension": "Installing Extension",
        "installing-magento": "Installing Magento",
        "installing-samples" : "Installing Sample Data",
        "installing-user" : "Installing User",
        "installing-files" : "Installing Files",
        "installing-data" : "Installing Data/Database"
    }
    
        if (new_status=="ready"){
            //remove progress bar and just insert label
            row.find("div.bar").parent().parent().html("<span class=\"label label-success item-status-label\">" + labels[new_status] + "</span>");
            location.reload();
        } else if(new_status != "pending") {
            //update progress bar status
            row.find("div.bar").html("" + labels[new_status] + "");
        } else {
            //update pending time counter
	    $.ajax({
            type: "POST",
            url: "'. $this->baseUrl("queue/getminutesleft") .'",
            data: "domain=" + row.find(".instancedomain").val(),
            dataType: "json",
            success: function(json){
                var time = '. $this->timeExecution .'*json;
                row.find("div.bar").html("In Queue - " + time + " minutes left");
            }
      });
        }
        
        //remove installing label now when everything is updated
        if (new_status.substr(0,10) != "installing" && new_status != "pending"){
            row.removeClass("installing");
        }
}');
?>

<div class="row">
    <div class="span6">
        <h1>Your stores</h1>
    </div>
    <div class="span6">
        <p>
            <a
                href="<?php echo $this->url(array('controller'=>'queue', 'action' => 'add'))?>"
                class="btn btn-primary btn-large pull-right"><i class="icon-plus icon-white"></i>&nbsp;Add store</a>
        </p>
    </div>
</div>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Name</th>
            <th width="20%">Status</th>
            <th>Edition</th>
            <th>Version</th>
            <th>Sample Data</th>
            <th>&nbsp;</th>
        </tr>
    </thead>
    <tbody>
        <?php $refreshed = 0; ?>
        <?php foreach($this->queue as $item): ?>
        <tr <?php echo (substr($item['status'],0,10) == 'installing' || $item['status'] == 'pending') ? 'class="installing"' : '' ?> >
            <td><?php echo $item['instance_name']?></td>
            <?php switch($item['status']): 
            case 'ready':?>
                <td><span class="label label-success item-status-label"><?php echo ucfirst($item['status']) ?></span> </td>
            <?php break; case 'pending':  ?>
            <?php if( ! $refreshed++ ) { $this->response->setHeader('Refresh', $this->timeExecution*60); } ?>
                <td>
                    <div class="progress progress-striped active" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar" style="width: 100%;">
                            In Queue - <?php echo $this->queueCounter[$item['id']]; ?> minutes left
                        </div>
                    </div>
                </td>
            <?php break; case 'closed': ?>
                <td><span class="label label-important">Closed</span></td>
            <?php break; case 'installing': ?>
            
                <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing..
                        </div>
                    </div>
	    </td>
            <?php break; case 'installing-extension': ?>
                <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing Extension..
                        </div>
                    </div>
	    </td>
                
	    <?php break; case 'installing-magento': ?>
                <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing Magento..
                        </div>
                    </div>
	    </td>
	    <?php break; case 'installing-samples': ?>
                <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing Sample Data..
                        </div>
                    </div>
	    </td>
	    <?php break; case 'installing-user': ?>
                <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing User..
                        </div>
                    </div>
	    </td>
	    <?php break; case 'installing-files': ?>
                <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing Files..
                        </div>
                    </div>
	    </td>
	    <?php break; case 'installing-date': ?>
	    <td>
	      <div class="progress progress-striped active span2" style="margin-bottom:0px;margin-top:5px;">
                        <div class="bar bar-success" style="width: 100%;">
                            Installing Data/Database..
                        </div>
                    </div>
	    </td>                
	    <?php break; case 'error': ?>
                <td><span class="label label-important">Error!</span>
                <?php echo ($item['error_message']) ? $item['error_message'] : ''  ?></td>
            <?php break; default: ?>
                <td><span class="label label-warning"></span></td>
            <?php endswitch; ?>
            <td><?php echo $item['edition']?></td>
            <td><?php echo $item['version']?></td>
            <td>
            <?php if($item['sample_data']): ?>
                <span class="label label-success">Yes</span>
            <?php else: ?>
                <span class="label label-important">No</span>
            <?php endif; ?>
            </td>
            <td>
            <?php if(in_array($item['status'], array('closed','pending','installing','installing-magento','installing-samples','installing-user','installing-files','installing-data'))): ?>
                <a class="btn btn-success disabled" rel="tooltip" data-placement="top" title="Visit store"><i class="icon-eye-close icon-white"></i></a>
                <a class="btn btn-info disabled" rel="tooltip" data-placement="top" title="Edit store details"><i class="icon-pencil icon-white"></i></a>
                <a class="btn btn-warning disabled" rel="tooltip" data-placement="top" title="Log in into store backend"><i class="icon-cog icon-white"></i></a>
                <a class="btn btn-danger disabled" rel="tooltip" data-placement="top" title="Delete store"><i class="icon-trash icon-white"></i></a>
                <a class="btn btn-info disabled" rel="tooltip" data-placement="top" title="Install extensions"><i class="icon-star icon-white"></i>&nbsp; Extensions</a>
                <?php if ($this->userGroup == 'admin'): ?>
                <a class="btn btn-info disabled" rel="tooltip" data-placement="top" title="Install extensions from Rocket Web repository."><i class="icon-star icon-white"></i>&nbsp;SVN</a>
                <?php endif; ?>
                <input type="hidden" class="instancedomain" value="<?php echo $item['domain'] ?>" />
            <?php else: ?>
                <a href="<?php echo $this->baseUrl('instance/'.$item['domain']); ?>" class="btn btn-success" rel="tooltip" data-placement="top" title="Visit store"><i class="icon-eye-open icon-white"></i></a>
                <a href="<?php echo $this->url(array('module' => 'default', 'controller' => 'queue', 'action' => 'edit', 'id' => $item['id']), 'default', true); ?>" class="btn btn-info" rel="tooltip" data-placement="top" title="Edit store details"><i class="icon-pencil icon-white"></i></a>
                <a href="<?php echo $this->baseUrl('instance/'.$item['domain'].'/admin/') ?>" target="_blank" class="btn btn-warning" rel="tooltip" data-placement="top" title="Log in into store backend"><i class="icon-cog icon-white"></i></a>
                <a href="<?php echo $this->url(array('module' => 'default', 'controller' => 'queue', 'action' => 'close', 'domain' => $item['domain']), 'default', true); ?>" class="btn btn-danger" rel="tooltip" data-placement="top" title="Delete store"><i class="icon-trash icon-white"></i></a>
                <a href="<?php echo $this->url(array('module' => 'default', 'controller' => 'queue', 'action' => 'extensions', 'instance' => $item['domain']), 'default', true); ?>" class="btn btn-info" rel="tooltip" data-placement="top" title="Install extensions"><i class="icon-star icon-white"></i>&nbsp; Extensions</a>
                <?php if ($this->userGroup == 'admin'): ?>
                <a href="<?php echo $this->url(array('module' => 'default', 'controller' => 'queue', 'action' => 'devextensions', 'instance' => $item['domain']), 'default', true); ?>" class="btn btn-info" rel="tooltip" data-placement="top" title="Install extensions from Rocket Web repository."><i class="icon-star icon-white"></i>&nbsp;SVN</a>
                <?php endif; ?>
            <?php endif;?>
                <a target="_blank" href="https://rocketwebinc.zendesk.com/anonymous_requests/new?ticket[fields][21917916]=<?php echo $this->url(array('module' => 'default', 'controller' => 'instance', 'action' => $item['domain']), 'default', true); ?>&email=<?php echo $this->user->email; ?>" class="btn btn-info" rel="tooltip" data-placement="top" title="Install extensions"><i class="icon-star icon-white"></i>&nbsp; ZenDesk</a>
            </td>
        </tr>
        <?php endforeach; ?>
    </tbody>
</table>
<?php echo $this->paginationControl($this->queue, 'Sliding', '_partials/paginationControl.phtml'); ?>